<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ffb744">
  <title>統合DB</title>

  <style>
    :root{
      --bg: #ffb744;
      --card: #ffffff;
      --text: #1a1a1a;
      --muted: #6b7280;
      --line: #e5e7eb;
      --thead: #ffe0b5;
      --focus: #3897c9;
      --logbg: #0b1220;
      --logtext: #d1e7ff;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      line-height: 1.7;
      margin: 12px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .row { display: flex; gap: 10px; align-items: center; }
    .row > * { flex: 1; }
    .row-controls { margin-top: 8px; }

    input[type="search"], select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--line);
      border-radius: 12px;
      font-size: 16px;
      background: #fff;
      color: var(--text);
      outline: none;
    }
    input[type="search"]:focus,
    select:focus,
    .btn:focus {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }
    #limit {
      padding: 6px 10px;
      font-size: 14px;
      line-height: 1.2;
      max-width: 160px;
    }
    .muted { color: var(--muted); font-size: 13px; }

    .btn {
      appearance: none;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn:hover { background: #f9fafb; }
    .btn:active { transform: translateY(1px); }

    .toast {
      position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%);
      background: rgba(17,24,39,.92); color: #fff;
      padding: 10px 14px; border-radius: 10px; font-size: 14px;
      opacity: 0; transition: opacity .2s ease;
    }
    .toast.show { opacity: 1; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
    th, td {
      border-bottom: 1px solid var(--line);
      padding: 10px 8px;
      font-size: 15px;
      vertical-align: top;
    }
    th {
      position: sticky; top: 0;
      background: var(--thead);
      z-index: 1;
      font-weight: 700;
    }
    th:nth-child(1), td:nth-child(1) { width: 35%; }
    th:nth-child(2), td:nth-child(2) { width: 50%; }
    th:nth-child(3), td:nth-child(3) { width: 15%; }
    .ops { display:flex; justify-content:flex-end; }

    /* ===== デバッグログ ===== */
    details.debug { margin-top: 10px; }
    details.debug summary { cursor: pointer; font-weight: 700; }
    .logbox {
      margin-top: 8px;
      background: var(--logbg);
      color: var(--logtext);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,.08);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.55;
      max-height: 260px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log-actions { display:flex; gap:8px; margin-top:8px; flex-wrap: wrap; }
    .pill {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      background: #fff;
    }

    @media (max-width: 768px) {
      table { display: none; }
      .mobile-list { display: block; margin-top: 10px; }
      .item {
        border-bottom: 1px solid var(--line);
        padding: 12px 2px;
        display: flex; flex-direction: column; gap: 6px;
      }
      .l1 {
        font-size: 16px; line-height: 1.6; font-weight: 700;
        display: flex; gap: 6px; flex-wrap: wrap;
      }
      .l1 .sep { opacity: .6; }
      .l2 {
        display: flex; align-items: center; gap: 8px; justify-content: flex-end; flex-wrap: wrap;
      }
      .btn { padding: 8px 12px; font-size: 14px; }
    }
  </style>
</head>
<body>

  <div class="card">
    <div class="row">
      <input id="q" type="search" placeholder="曲名／アーティスト名で検索（例：群青日和／椎名林檎）" autocomplete="off">
    </div>
    <div class="row row-controls">
      <select id="limit">
        <option value="50">上限 50件</option>
        <option value="100">上限 100件</option>
        <option value="200">上限 200件</option>
      </select>
    </div>
    <div class="muted" id="status">読み込み中…</div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="muted" id="hint">検索結果がここに表示されます。</div>
    <div id="table"></div>
    <div id="mblist" class="mobile-list" style="display:none;"></div>

    <!-- ===== デバッグログ（原因特定用） ===== -->
    <details class="debug">
      <summary>デバッグログ（原因特定用）</summary>
      <div class="muted" style="margin-top:6px;">
        <span class="pill" id="pillApi">API: -</span>
        <span class="pill" id="pillCb">callback: -</span>
      </div>
      <div id="log" class="logbox">（ここにログが出ます）</div>
      <div class="log-actions">
        <button class="btn" id="btnCopyLog">ログをコピー</button>
        <button class="btn" id="btnClearLog">ログをクリア</button>
        <button class="btn" id="btnPing">APIテスト（別タブ）</button>
      </div>
      <div class="muted" style="margin-top:6px;">
        ※ まずは「APIテスト（別タブ）」で <code>onGviz(...)</code> が返るか確認してください。
      </div>
    </details>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">コピーしました</div>

  <script>
    /* ===== 設定 ===== */
    const API_URL = 'https://script.google.com/macros/s/AKfycbz9TUzC2C2dQgUbdCX1jAXNKIb4WpalGo08Ha8jdmIZ-Gx5GX-ie-kuaC9urKATEPTp/exec';
    const HARD_LIMIT = 200;

    const state = { rows: [], debounce: null };
    let callbackCalled = false;
    let lastJsonpUrl = '';

    /* ===== ログ機構（画面内に出す） ===== */
    const LOG_MAX_LINES = 400;
    const logLines = [];
    function $(id){ return document.getElementById(id); }

    function safeStr(x){
      try{
        if (typeof x === 'string') return x;
        if (x instanceof Error) return (x.stack || x.message || String(x));
        return JSON.stringify(x);
      } catch {
        return String(x);
      }
    }

    function log(level, ...args){
      const ts = new Date().toISOString().replace('T',' ').replace('Z','');
      const msg = args.map(safeStr).join(' ');
      const line = `[${ts}] [${level}] ${msg}`;

      logLines.push(line);
      while (logLines.length > LOG_MAX_LINES) logLines.shift();

      const el = $('log');
      if (el) {
        el.textContent = logLines.join('\n');
        el.scrollTop = el.scrollHeight;
      }
    }

    // consoleも画面ログへミラー
    (function hookConsole(){
      const orig = {
        log: console.log.bind(console),
        warn: console.warn.bind(console),
        error: console.error.bind(console),
      };
      console.log = (...a)=>{ log('console.log', ...a); orig.log(...a); };
      console.warn = (...a)=>{ log('console.warn', ...a); orig.warn(...a); };
      console.error = (...a)=>{ log('console.error', ...a); orig.error(...a); };
    })();

    // JS例外も捕捉
    window.addEventListener('error', (ev)=>{
      log('window.error', ev.message, 'at', ev.filename + ':' + ev.lineno + ':' + ev.colno);
    });
    window.addEventListener('unhandledrejection', (ev)=>{
      log('unhandledrejection', ev.reason);
    });

    function setPills(){
      $('pillApi').textContent = 'API: ' + API_URL;
      $('pillCb').textContent  = 'callback: onGviz';
    }

    function showToast(msg){
      const t = $('toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1400);
    }

    async function copyText(text){
      try{
        if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else {
          const ta = document.createElement('textarea');
          ta.value = text; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); ta.remove();
        }
        return true;
      } catch {
        return false;
      }
    }

    async function copyPair(title, artist){
      const t = (title||'').trim();
      const a = (artist||'').trim();
      const text = (t && a) ? `${t} / ${a}` : (t || a);
      const ok = await copyText(text);
      showToast(ok ? ('コピーしました：' + text) : 'コピーに失敗しました');
    }

    function normalize(s){ return (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim(); }
    function scheduleSearch(){ clearTimeout(state.debounce); state.debounce = setTimeout(render, 220); }

    /* ===== JSONP コールバック ===== */
    function onGviz(payload) {
      callbackCalled = true;
      try {
        log('jsonp.callback', 'onGviz called', { ok: payload?.ok, rowsType: typeof payload?.rows, len: payload?.rows?.length });

        if (!payload || !payload.ok || !Array.isArray(payload.rows)) {
          $('status').textContent = 'データ取得に失敗しました（不正なレスポンス）';
          log('error', 'Invalid payload', payload);
          return;
        }

        const rows = payload.rows.map(r => {
          if (Array.isArray(r)) {
            return { artist: (r[0] ?? '').toString(), title: (r[1] ?? '').toString() };
          }
          return { artist: (r.artist ?? '').toString(), title: (r.title ?? '').toString() };
        }).filter(r => ((r.artist + r.title).trim() !== ''));

        rows.sort((x,y) => {
          const a1 = x.artist.trim(), a2 = y.artist.trim();
          if (a1 !== a2) return a1.localeCompare(a2, 'ja');
          return (x.title.trim()).localeCompare(y.title.trim(), 'ja');
        });

        state.rows = rows;
        $('status').textContent = `読み込み完了：${rows.length}件`;
        log('info', 'Loaded rows', rows.length, 'sample=', rows[0] || '(none)');
        render();
      } catch (e) {
        $('status').textContent = '読み込みに失敗しました';
        log('error', 'Exception in onGviz', e);
      }
    }
    window.onGviz = onGviz;

    /* ===== 描画 ===== */
    function render(){
      const tableWrap = $('table'); tableWrap.innerHTML = '';
      const listWrap  = $('mblist'); listWrap.innerHTML = '';
      const hint = $('hint');

      const q = normalize($('q').value || '');
      const limitSelected = parseInt($('limit').value, 10);
      const limit = Math.min(isFinite(limitSelected) ? limitSelected : 50, HARD_LIMIT);

      let filtered = state.rows;
      if (q) {
        filtered = filtered.filter(({artist, title}) => {
          return normalize(artist).includes(q) || normalize(title).includes(q);
        });
      }
      const rows = filtered.slice(0, limit);

      $('status').textContent = q
        ? `${rows.length}件ヒット（全${filtered.length}件）／表示上限 ${limit}件`
        : `表示中 ${rows.length}件（全${state.rows.length}件）／表示上限 ${limit}件`;

      if (rows.length === 0) { hint.textContent = q ? '該当なし' : '検索結果がここに表示されます。'; return; }
      hint.textContent = '';

      // PC：テーブル
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      ['アーティスト名','曲名','コピー'].forEach(h=>{
        const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
      });
      thead.appendChild(trh); table.appendChild(thead);

      const tbody = document.createElement('tbody');
      rows.forEach(({artist, title})=>{
        const tr = document.createElement('tr');

        let td = document.createElement('td'); td.textContent = artist || ''; tr.appendChild(td);
        td = document.createElement('td'); td.textContent = title || ''; tr.appendChild(td);

        const tdOps = document.createElement('td');
        const ops = document.createElement('div'); ops.className = 'ops';

        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'コピー';
        btn.addEventListener('click', ()=> copyPair(title, artist));
        ops.appendChild(btn);

        tdOps.appendChild(ops);
        tr.appendChild(tdOps);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      tableWrap.appendChild(table);

      // スマホ：2行カード
      rows.forEach(({artist, title})=>{
        const item = document.createElement('div'); item.className = 'item';

        const l1 = document.createElement('div'); l1.className = 'l1';
        const a1 = document.createElement('span'); a1.className='artist'; a1.textContent = artist || '';
        const sep = document.createElement('span'); sep.className='sep'; sep.textContent = '/';
        const t1 = document.createElement('span'); t1.className='title'; t1.textContent = title || '';
        l1.appendChild(a1); l1.appendChild(sep); l1.appendChild(t1);

        const l2 = document.createElement('div'); l2.className = 'l2';
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='コピー';
        btn.addEventListener('click', ()=> copyPair(title, artist));
        l2.appendChild(btn);

        item.appendChild(l1); item.appendChild(l2);
        listWrap.appendChild(item);
      });

      listWrap.style.display = 'block';
    }

    /* ===== データ取得開始（JSONP） ===== */
    (function load(){
      setPills();
      log('info', 'Page loaded', { href: location.href, ua: navigator.userAgent });

      const s = document.createElement('script');
      lastJsonpUrl = `${API_URL}?callback=onGviz&limit=${HARD_LIMIT}&v=${Date.now()}`;

      log('info', 'JSONP request start', lastJsonpUrl);

      s.src = lastJsonpUrl;

      s.onload = ()=> {
        log('info', 'JSONP script tag loaded (onload)');
        // onloadだけでは成功とは限りません（中身がHTMLでもonloadは通るため）
      };

      s.onerror = ()=> {
        $('status').textContent = 'データ取得に失敗しました（ネットワーク/ブロック）';
        log('error', 'JSONP script load error', lastJsonpUrl);
      };

      document.head.appendChild(s);

      // callbackが呼ばれない検知（権限/HTML応答/遮断を炙り出す）
      setTimeout(()=> {
        if (!callbackCalled) {
          $('status').textContent = 'データ取得に失敗しました（callback未呼び出し）';
          log('warn', 'Callback not called within timeout. Possible causes: permission, API returns HTML, blocked, wrong URL.');
          log('warn', 'Try opening this URL directly:', lastJsonpUrl);
        }
      }, 6000);

    })();

    /* ===== イベント ===== */
    $('q').addEventListener('input', scheduleSearch);
    $('limit').addEventListener('change', render);

    $('btnCopyLog').addEventListener('click', async ()=>{
      const ok = await copyText(logLines.join('\n'));
      showToast(ok ? 'ログをコピーしました' : 'ログコピーに失敗しました');
    });

    $('btnClearLog').addEventListener('click', ()=>{
      logLines.length = 0;
      $('log').textContent = '（ここにログが出ます）';
      showToast('ログをクリアしました');
    });

    $('btnPing').addEventListener('click', ()=>{
      const u = `${API_URL}?callback=onGviz&limit=3&v=${Date.now()}`;
      window.open(u, '_blank', 'noopener');
      log('info', 'Open API test tab', u);
    });
  </script>
</body>
</html>
